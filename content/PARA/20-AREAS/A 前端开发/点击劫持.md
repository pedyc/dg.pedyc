---
title: 点击劫持
aliases: [Clickjacking, UI Redressing, 界面伪装攻击]
tags: [领域/安全, 浏览器/安全, 核心概念]
date-created: 2025-12-17
date-modified: 2025-12-25
related: ["[[Web安全]]", "[[CSP]]", "[[HTTP响应头]]"]
---

## 🛡️ 核心概念：点击劫持 (Clickjacking)

### 🔎 核心定义

> [!abstract] 透明的陷阱
> **点击劫持 (Clickjacking)**，又称 " 界面伪装攻击 " (UI Redressing)。
> 攻击者使用一个**透明的、不可见的 `<iframe>`**，覆盖在诱导性的网页按钮之上。用户以为自己点击了 " 领取奖品 "，实际上点击的是隐藏在透明层下的 " 银行转账 " 或 " 点赞 " 按钮。
>
> *一句话总结*：**你以为你在点 A，其实你在点 B。**

---

### 🏗️ 攻击原理 (The Mechanism)

攻击者利用了 CSS 的 `z-index` 和 `opacity` 属性。

```mermaid
graph TD
    subgraph Browser ["💻 用户视口 (Browser)"]
        Layer1["🔴 顶层: 目标网站 iframe<br>(opacity: 0, z-index: 999)"]
        Layer2["🟢 底层: 钓鱼页面<br>(诱导按钮: '点击中奖')"]
        Mouse["🖱️ 用户点击"]
    end
    
    Mouse -->|穿透视觉| Layer1
    Layer1 -->|触发真实操作| Target["目标网站后端<br>(转账/关注/删除)"]
    
    %% 样式定义
    style Layer1 fill:#ffcccc,stroke:#333,stroke-dasharray: 5 5
    style Layer2 fill:#ccffcc,stroke:#333
````

#### 攻击步骤

1. **嵌入**：攻击者在自己的恶意网站中，用 `iframe` 嵌入受害者已登录的目标网站（如网银页面）。
2. **隐藏**：将 `iframe` 设置为透明 (`opacity: 0`)。
3. **定位**：通过 CSS 绝对定位，将目标网站的关键按钮（如 " 确认转账 "）精确覆盖在恶意网站的诱导按钮上。
4. **诱导**：用户被诱导点击，浏览器认为用户是主动在 `iframe` 内操作，请求被放行（因为 Cookie 是自带的）。

---

### 🛡️ 防御体系 (Defense Strategy)

防御的核心思想是：**禁止我的网页被别人嵌入 `iframe`**。

#### 1. 现代标准：CSP (frame-ancestors) 🔥

这是推荐的现代防御方式，控制粒度更细。

- **指令**：`Content-Security-Policy: frame-ancestors <source>;`
- **作用**：指定哪些父页面可以嵌入当前页面。
- **配置示例**：

	HTTP

```bash

## 🚫 禁止所有网站嵌入（包括同源）

	Content-Security-Policy: frame-ancestors 'none';
	

## ✅ 只允许同源网站嵌入

	Content-Security-Policy: frame-ancestors 'self';
	

## 🤝 允许特定域名嵌入

	Content-Security-Policy: frame-ancestors [https://partner.site.com](https://partner.site.com);

```

> [!warning] 易混淆点
>
> - `frame-ancestors`：控制 **谁能嵌入我**（防御点击劫持）。
> 
> - `frame-src`：控制 **我能嵌入谁**（限制我页面里的 iframe 加载内容）。

### 2. 传统标准：X-Frame-Options (XFO)

兼容性最好的老牌方案（HTTP 响应头）。

- **DENY**：拒绝被任何页面嵌入（包括同源）。
- **SAMEORIGIN**：只允许同源页面嵌入（最常用）。
- **ALLOW-FROM uri**：(已废弃) 允许指定页面。

### 3. 前端防御：Frame Busting (已过时)

早期的 JS 防御脚本，试图跳出 iframe。

JavaScript

```bash
if (top.location !== self.location) {
  top.location = self.location;
}
```

- **缺陷**：很容易被攻击者通过 `<iframe sandbox="allow-forms">` 禁用 JS 跳转而绕过，**不建议作为唯一防御手段**。

---

## 💻 落地实践 (Implementation)

点击劫持防御通常在网关层（Nginx）或应用服务层配置响应头。

**Nginx 配置：**

Nginx

```bash
# 推荐组合：同时设置 CSP 和 X-Frame-Options
add_header X-Frame-Options "SAMEORIGIN";
add_header Content-Security-Policy "frame-ancestors 'self'";
```

**Next.js (`next.config.js`)：**

JavaScript

```bash
module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN',
          },
          {
            key: 'Content-Security-Policy',
            value: "frame-ancestors 'self'", // 需注意合并其他 CSP 指令
          }
        ],
      },
    ];
  },
};
```

---

## 📝 自检清单 (Checklist)

| **检查项**             | **说明**                                                                 |
| ------------------- | ---------------------------------------------------------------------- |
| X-Frame-Options | 是否配置了 `SAMEORIGIN` 或 `DENY`？这是底线。                                      |
| CSP             | 是否使用了 `frame-ancestors`？如果浏览器支持 CSP，它会覆盖 X-Frame-Options。              |
| Cookie Samesite | 设置 `SameSite=Strict` 或 `Lax` 可以辅助防御（阻止第三方 Cookie 发送），但不能完全替代上述 Header。 |

## 🔗 参考资料

- [[MDN Web Security - Clickjacking]]
- [[HTTP响应头]]
